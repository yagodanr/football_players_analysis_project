```{r}
library(pacman)
p_load(dplyr)
p_load(lubridate)
p_load(ggplot2)
p_load(fitdistrplus)
p_load(performance)
```

# Dataset processing

## goals dataset

```{r}
game_events <- read.csv("./player-scores/game_events.csv")
players     <- read.csv("./player-scores/players.csv")
clubs       <- read.csv("./player-scores/clubs.csv")
games       <- read.csv("./player-scores/games.csv")
```

```{r}
game_events <- dplyr::select(game_events, !c(game_event_id, player_in_id, player_assist_id))
games       <- dplyr::select(games, game_id, spectators=attendance,
						home_club_name, away_club_name,
						home_club_goals, away_club_goals)
players     <- dplyr::select(players, player_id, player=name, date_of_birth)
clubs       <- dplyr::select(clubs, club_id, player_club=name)
```

```{r}
head(players)
```

```{r}

game_events <- merge(game_events, players, by = "player_id", all = TRUE)
game_events <- merge(game_events, clubs, by = "club_id", all = TRUE)
game_events <- merge(game_events, games, by = "game_id", all = TRUE)

```

```{r}
# summary(game_events)
game_events <- game_events %>% filter(!is.na(player))
game_events <- arrange(game_events, date, minute)
head(game_events, 100)
```
```{r}
summary(game_events)
```



```{r}
goals   <- game_events[game_events$type=="Goals", ]
head(goals)
```

## appearances dataset

```{r}
appearances <- read.csv("./player-scores/appearances.csv")
appearances <- merge(appearances, clubs, by.x = "player_club_id", by.y = "club_id")
appearances <- merge(appearances, players, by.x = "player_id", by.y = "player_id")
appearances <- dplyr::select(appearances, player_club_id, game_id, player_id,
                      date, player=player_name, player_club,
                      minutes_played,yellow_cards, red_cards, goals, assists,
                      date_of_birth)
appearances <- appearances %>%
  mutate( 
    dob = as.Date(date_of_birth),
    age_at_match = as.numeric(difftime(as.Date(date), dob, units = "days")) / 365.25
  )
```

```{r}
head(appearances)
```
```{r}
summary(appearances)
```

# Hypothesis 1: Goals in match follow Poisson distribution

```{r}
goals_per_team <- goals %>%
  group_by(game_id) %>%
  summarise(goals_count = n(), .groups = "drop")

all_games <- games %>%
  dplyr::select(game_id) %>%
  left_join(goals_per_team, by = "game_id") %>%
  mutate(goals_count = ifelse(is.na(goals_count), 0, goals_count))

observed_freq <- all_games %>%
  group_by(goals_count) %>%
  summarise(observed = n(), .groups = "drop") %>%
  mutate(observed_proportion = observed / sum(observed))

lambda <- mean(all_games$goals_count)
cat("Mean value of goals per game:", lambda, "\n")

max_goals <- max(observed_freq$goals_count)
expected_freq <- data.frame(
  goals_count = 0:max_goals,
  expected_proportion = dpois(0:max_goals, lambda)
)

comparison <- observed_freq %>%
  full_join(expected_freq, by = "goals_count") %>%
  arrange(goals_count) %>%
  mutate(
    expected = expected_proportion * sum(observed_freq$observed),
    observed = ifelse(is.na(observed), 0, observed)
)

print(comparison)

# Chi-square goodness of fit test
comparison_chi <- comparison %>% mutate(group = case_when(goals_count <= 5 ~ as.character(goals_count), TRUE ~ "6+")) %>%
  group_by(group) %>% summarise(observed = sum(observed), expected = sum(expected), .groups = "drop") %>%
  filter(expected >= 5)

chi_test <- chisq.test(x = comparison_chi$observed, p = comparison_chi$expected / sum(comparison_chi$expected))

cat("\nChi-square test results:\n")
cat("Chi-square statistic:", chi_test$statistic, "\n")
cat("Degrees of freedom:", chi_test$parameter, "\n")
cat("P-value:", chi_test$p.value, "\n")

if (chi_test$p.value > 0.05) {
  cat("We do not reject the null hypothesis (p > 0.05).\n")
  cat("The data follows a Poisson distribution.\n")
} else {
  cat("We reject the null hypothesis (p < 0.05).\n")
  cat("The given data does not follow a Poisson distribution.\n")
}

# Kolmogorov-Smirnov test
ks_test <- ks.test(all_games$goals_count, "ppois", lambda)
cat("\nKolmogorov-Smirnov test results:\n")
cat("D statistic:", ks_test$statistic, "\n")
cat("P-value:", ks_test$p.value, "\n")

# Observed vs Expected frequencies
comparison_long <- comparison %>%
  dplyr::select(goals_count, observed, expected) %>%
  tidyr::pivot_longer(cols = c(observed, expected), names_to = "type", values_to = "frequency")

ggplot(comparison_long, aes(x = goals_count, y = frequency, fill = type)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  labs(
    title = "Observed vs Expected Frequencies (Poisson Distribution)",
    subtitle = paste("Lambda =", round(lambda, 3)),
    x = "Number of Goals per Game",
    y = "Frequency",
    fill = "Type"
  ) + theme_minimal() + theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"), plot.subtitle = element_text(hjust = 0.5, size = 10)) +
  scale_fill_manual(values = c("observed" = "#3498DB", "expected" = "#E74C3C"))

ggplot(all_games, aes(sample = goals_count)) +
  stat_qq(distribution = qpois, dparams = list(lambda = lambda)) +
  stat_qq_line(distribution = qpois, dparams = list(lambda = lambda), 
               color = "red", size = 1) +
  labs(title = "Quantile-Quantile Plot: Goals vs Poisson Distribution", x = "Theoretical Poisson Quantiles", y = "Sample Quantiles") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))

cat("Statistical analysis\n")

cat("Hypothesis test results:\n")
cat("Chi-square Test:\n")
cat("Statistic: ", chi_test$statistic, "\n")
cat("Degrees of Freedom: ", chi_test$parameter, "\n")
cat("P-value: ", format(chi_test$p.value, scientific = TRUE), "\n\n")

cat("Kolmogorov-Smirnov Test:\n")
cat("D Statistic: ", round(ks_test$statistic, 4), "\n")
cat("P-value: ", format(ks_test$p.value, scientific = TRUE), "\n\n")

cat("Conclusion\n")

cat("The data does not follow a Poisson distribution.\n")
cat("Both statistical tests reject the null hypothesis (p-values < 0.05).\n\n")

cat("Though the bar chart shows rough alignment between observed and expected.\n")
cat("Unfortunately even small deviations on big sample sizes are significant.\n")

cat("Mean goals per game: ", round(lambda, 3), "\n")
cat("Variance: ", round(var(all_games$goals_count), 3), "\n")
cat("Variance/Mean: ", round(var(all_games$goals_count) / lambda, 3), "\n")
cat("In case of Poisson distribution, variance should equal to the mean.\n")

cat("While the Poisson distribution helps demonstrate general shape of goal scoring\n")
cat("the deviations indicate that real-world football goal\n")
cat("distributions vary severely more than the Poisson model predicts.\n\n")

cat("The extremely small p-values (< 2.2e-16) is a very strong evidence to reject\n")
cat("the hypothesis about Poisson distribution, despite the visually acceptable fit.\n\n")

```

# Hypothesis 2: Players perform worse after certain age

```{r}
target_names <- "Lionel Messi|Cristiano Ronaldo|Zlatan Ibrahimović"

superstars_df <- appearances %>%
  filter(grepl(target_names, player, ignore.case = TRUE)) %>%
  filter(minutes_played > 45) %>%
  mutate(player_label = case_when(
    grepl("Lionel Messi", player) ~ "Lionel Messi",
    grepl("Cristiano Ronaldo", player) ~ "Cristiano Ronaldo",
    grepl("Zlatan Ibrahimović", player) ~ "Zlatan Ibrahimović",
    TRUE ~ player
  ))

superstars_anova <- superstars_df %>%
  mutate(career_stage = case_when(
    age_at_match < 35 ~ "Prime (Yonger than 35)",
    age_at_match >= 35 ~ "Veteran (35+)"
  ))

ggplot(superstars_anova, aes(x = career_stage, y = goals, fill = player_label)) +
  geom_boxplot(alpha = 0.5) +
  labs(
    title = "Performance by Age",
    subtitle = "Comparing Prime(<35) vs. Veteran (35+)",
    x = "Career Stage",
    y = "Goals + Assists per Match"
  ) +
  theme_minimal()

model_superstar <- aov(goals ~ career_stage, data = superstars_anova)

cat("--- ANOVA Results for Superstars ---\n")
summary(model_superstar)

cat("\n--- Detailed Comparison ---\n")
TukeyHSD(model_superstar)
```

### Explanation

Define the performance of a player as the #goals per match(given that the player spent at least 45 minutes playing in that match). Break down the data in two groups:

1.  Prime: performance at younger age(\<35 y.o.)
2.  Veteran: performance at older age (35+ y.o)

By using the ANOVA test we can calculate the statistical difference between the average performance of two groups(and if is difference is due to noise or not).

The hypothesis is as follows:

$$H_0: \mu_{prime} = \mu_{veteran} \text{ vs. } H_1 : \mu_{prime} \ne \mu_{veteran}$$

From our data we get $$p = 3.05e-05$$, therefore we can reject $$H_0$$ with great confidence.

After finding a statistical difference in data (meaning that indeed two groups perform diffirently), we use Tukey HSD to understand which group actually performs better and by how much.

The $$diff$$ parameter in the test is equal to $$-0.2876461 < 0$$ which tells us that the "Prime" group on average performs better(as we testes "Veteran"-"Prime"). The adjusted $$p$$ value of $$3.05e-05$$ confirms that the difference is statistically significant.

In conclusion we can say that the "Veteran" group performs worse by 0.28 Goals per game. Which in a 38-game season gives a difference of 10-11 goals.

It should be mentioned that the data-set consists of data from 2012 and onward, so technically the prime group is defined as:

Messi (25-34 y.o.)

Ronaldo (27-34 y.o.)

Ibrahimović (31-34 y.o.)


# Hypothesis 3: Seasonal performance
Our hypothesis is that players' performance depends on year season

```{r}
players_of_interest <- c("Cristiano Ronaldo", "Lionel Messi", "Luka Modric", "Thomas Müller", "Neymar", "Kylian Mbappé")
appearances_of_interest <- filter(appearances, player %in% players_of_interest)
```

```{r}
appearances_of_interest <- appearances_of_interest %>%
  mutate(
    month 	= month(date),
	year 	= year(date),
    season 	= case_when(
      month %in% c(12, 1, 2) ~ "Winter",
      month %in% c(3, 4, 5) ~ "Spring",
      month %in% c(6, 7, 8) ~ "Summer",
      month %in% c(9, 10, 11) ~ "Autumn",
      TRUE ~ NA_character_
    )
  )

player_season_stats <- appearances_of_interest %>%
  group_by(player, year, season) %>%
  summarise(
    games = n(),
    goals = sum(goals, na.rm = TRUE),
    assists = sum(assists, na.rm = TRUE),
    minutes = sum(minutes_played, na.rm = TRUE),
	avg_goals = (goals+assists)/games,
    .groups = "drop"
  ) %>%
  arrange(player, year, season)

player_yearly_stats <- appearances_of_interest %>%
  group_by(player, year) %>%
  summarise(
    games = n(),
    goals = sum(goals, na.rm = TRUE),
    assists = sum(assists, na.rm = TRUE),
    minutes = sum(minutes_played, na.rm = TRUE),
    avg_goals = (goals+assists) / games,
    .groups = "drop"
  )
```

```{r}
# Create the line plot
ggplot(player_yearly_stats, aes(x = year, y = avg_goals, color = player)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Average Goals + Assists per Game by Year",
    x = "Year",
    y = "Average Goals + Assists per Game",
    color = "Player"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
  ) +
  scale_color_manual(values = c(
    "Cristiano Ronaldo" = "#E74C3C",
    "Lionel Messi" = "#3498DB",
    "Luka Modric" = "#F39C12",
    "Thomas Müller" = "#9B59B6",
    "Neymar" = "#2ECC71",
    "Kylian Mbappé" = "#E67E22"
  ))

# Create line plot with facets for each season
ggplot(player_season_stats, aes(x = year, y = avg_goals, color = player)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ season, ncol = 2) +
  labs(
    title = "Average Goals + Assists per Game by Season Across Years",
    x = "Year",
    y = "Average Goals + Assists per Game",
    color = "Player"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, line = 14, face = "bold"),
    strip.text = element_text(face = "bold", size = 12)
  ) +
  scale_color_manual(values = c(
    "Cristiano Ronaldo" = "#E74C3C",
    "Lionel Messi" = "#3498DB",
    "Luka Modric" = "#F39C12",
    "Thomas Müller" = "#9B59B6",
    "Neymar" = "#2ECC71",
    "Kylian Mbappé" = "#E67E22"
  ))
```
In the plot above we see average number of `goals+assists per match` as measure of players' performance and it's values across years overall and grouped by season. The plots are messy and hard to analyze. Nevertheless, we might wee, that summer is of 4 seasons giving zeros, like having no data and then large peaks of 2 and 2.5 average statistics. 


```{r}
ggplot(player_season_stats, aes(x = avg_goals, fill = season, color = season)) +
  geom_density(alpha = 0.5, size = 1) +
  facet_wrap(~ player, ncol = 2, scales = "free_y") +   # keep Y free but fix X
  coord_cartesian(xlim = c(0, 2.5)) +
  labs(
    title = "Distribution of Average Goals + Assists per Game by Player",
    x = "Average Goals + Assists per Game",
    y = "Density",
    fill = "Season",
    color = "Season"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    strip.text = element_text(face = "bold", size = 11)
  )

```
This plot look much cleaner and provides us with total emprical densities of seasonal performance for each player. 
These plots definitively show the extrime consistency of Lionel Messi throughout career at any season with a slight lower performance in summer and spring. 
Ronaldo also look dominant, however on summer he does not have season with average score >= 1.5 and has lot of 0.5 and 0 scores, which stands out of his performance during other seasons.
Neymar show, that he both in summer and winter had all values of average performance from 0 to 2.5, yet more <1.0 on summer. More consistent on autumn and spring
Luka Modric here is to point out, that average number of goals+assists is not the absolute measure of performance in football, as he is regarded as one of the best central midlfielder, yet scores so rarely. That is obviously because he is supposed to be defender, not the scorer

```{r}
df <- appearances_of_interest
# Ensure date column is Date type
df$date <- as.Date(df$date)

# Add year and season_period columns
df <- df %>%
  mutate(
    year = year(date),
    month = month(date)
  ) %>%
  arrange(date)

# Compute average goals+assists per season per year
season_summary <- df %>%
  group_by(year, season) %>%
  summarise(
    avg_goals_assists = mean(goals + assists, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  # Add a representative date for plotting
  mutate(season_date = case_when(
    season == "Winter" ~ as.Date(paste0(year, "-01-15")),
    season == "Spring" ~ as.Date(paste0(year, "-04-15")),
    season == "Summer" ~ as.Date(paste0(year, "-07-15")),
    season == "Autumn" ~ as.Date(paste0(year, "-10-15"))
  ))

# Plot
ggplot(season_summary, aes(x = season_date, y = avg_goals_assists, color = factor(season))) +
  geom_point(size = 3) +
  labs(x = "Season", y = "Average Goals + Assists", color = "Year") +
  theme_minimal()


```
Here we see out mean statistic across season on y-axis, and date on x-axis, and each season is colored differently. Here we see, that performance differs from year, to year, but stays close to each other across seasons(for 2016-2023 it is $\approx1.0$).
However summer stands out with lower values the average that year. Is it statistically significant?
Also the plot shows, that performance it stable at about 0.9 till 2023, but after it drops significantly. Supposedly because of the lack of data, as it first showed not data on Ronaldo after 2022 and some others.

```{r}
# Run ANOVA
anova_model <- aov(avg_goals_assists ~ season, data = season_summary)

# Show summary
summary(anova_model)

# Post-hoc pairwise comparison (if significant)
TukeyHSD(anova_model)
```
This is a test: 
$$
H_0: mean\ performance\ is\ the\ same\ in\ every\ season\\
H_1: mean\ differs
$$
season shows how much of the data season explains and residulas shows how much it doesn't. Residual is large.
$Pr(>F)=0.317$ means, that there is 31.7% probability of seeing the data under $H_0$

next we see comparison and testing between individual seasons. The most important value is p adj, which means p_value of the same test with $H_0$ but for specified pair of seasons. The smallest values are indeed $Summer-Autumn$ and $Winter-Summer$, however they are still far from being statistically significant.

Therefore we reject $H_0$ and conclude, that average number of goals+assists does not depend on year season.
