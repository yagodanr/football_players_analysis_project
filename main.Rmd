```{r}
library(pacman)
p_load(dplyr)
p_load(lubridate)
p_load(ggplot2)
```


# Dataset processing
## goals dataset
```{r}
game_events <- read.csv("./player-scores/game_events.csv")
players     <- read.csv("./player-scores/players.csv")
clubs       <- read.csv("./player-scores/clubs.csv")
games       <- read.csv("./player-scores/games.csv")
```

```{r}
game_events <- select(game_events, !c(game_event_id, player_in_id, player_assist_id))
games       <- select(games, game_id, spectators=attendance,
						home_club_name, away_club_name,
						home_club_goals, away_club_goals)
players     <- select(players, player_id, player=name)
clubs       <- select(clubs, club_id, player_club=name)
```

```{r}

game_events <- merge(game_events, players, by = "player_id", all = TRUE)
game_events <- merge(game_events, clubs, by = "club_id", all = TRUE)
game_events <- merge(game_events, games, by = "game_id", all = TRUE)

```

```{r}
# summary(game_events)
game_events <- game_events %>% filter(!is.na(player))
game_events <- arrange(game_events, date, minute)
head(game_events, 100)
```


```{r}
goals   <- game_events[game_events$type=="Goals", ]
head(goals)
```

## appearances dataset
```{r}
appearances <- read.csv("./player-scores/appearances.csv")
appearances <- merge(appearances, clubs, by.x = "player_club_id", by.y = "club_id")
appearances <- select(appearances, player_club_id, game_id, player_id, date,
				player=player_name, player_club, minutes_played,
				yellow_cards, red_cards, goals, assists)
```

```{r}
head(appearances)
```

# Analysis
```{r}
players_of_interest <- c("Cristiano Ronaldo", "Lionel Messi", "Luka Modric", "Thomas Müller", "Neymar", "Kylian Mbappé")
appearances_of_interest <- filter(appearances, player %in% players_of_interest)
```

```{r}
appearances_of_interest <- appearances_of_interest %>%
  mutate(
    month 	= month(date),
	year 	= year(date),
    season 	= case_when(
      month %in% c(12, 1, 2) ~ "Winter",
      month %in% c(3, 4, 5) ~ "Spring",
      month %in% c(6, 7, 8) ~ "Summer",
      month %in% c(9, 10, 11) ~ "Autumn",
      TRUE ~ NA_character_
    )
  )

player_season_stats <- appearances_of_interest %>%
  group_by(player, year, season) %>%
  summarise(
    games = n(),
    goals = sum(goals, na.rm = TRUE),
    assists = sum(assists, na.rm = TRUE),
    minutes = sum(minutes_played, na.rm = TRUE),
	avg_goals = (goals+assists)/games,
    .groups = "drop"
  ) %>%
  arrange(player, year, season)

player_yearly_stats <- appearances_of_interest %>%
  group_by(player, year) %>%
  summarise(
    games = n(),
    goals = sum(goals, na.rm = TRUE),
    assists = sum(assists, na.rm = TRUE),
    minutes = sum(minutes_played, na.rm = TRUE),
    avg_goals = (goals+assists) / games,
    .groups = "drop"
  )
```
```{r}
# Create the line plot
ggplot(player_yearly_stats, aes(x = year, y = avg_goals, color = player)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Average Goals + Assists per Game by Year",
    x = "Year",
    y = "Average Goals + Assists per Game",
    color = "Player"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
  ) +
  scale_color_manual(values = c(
    "Cristiano Ronaldo" = "#E74C3C",
    "Lionel Messi" = "#3498DB",
    "Luka Modric" = "#F39C12",
    "Thomas Müller" = "#9B59B6",
    "Neymar" = "#2ECC71",
    "Kylian Mbappé" = "#E67E22"
  ))

# Create line plot with facets for each season
ggplot(player_season_stats, aes(x = year, y = avg_goals, color = player)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ season, ncol = 2) +
  labs(
    title = "Average Goals + Assists per Game by Season Across Years",
    x = "Year",
    y = "Average Goals + Assists per Game",
    color = "Player"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    strip.text = element_text(face = "bold", size = 12)
  ) +
  scale_color_manual(values = c(
    "Cristiano Ronaldo" = "#E74C3C",
    "Lionel Messi" = "#3498DB",
    "Luka Modric" = "#F39C12",
    "Thomas Müller" = "#9B59B6",
    "Neymar" = "#2ECC71",
    "Kylian Mbappé" = "#E67E22"
  ))
```
```{r}
# Density plots faceted by player, colored by season
ggplot(player_season_stats, aes(x = avg_goals, fill = season, color = season)) +
  geom_density(alpha = 0.5, size = 1) +
  facet_wrap(~ player, ncol = 2, scales = "free") +
  labs(
    title = "Distribution of Average Goals + Assists per Game by Player",
    x = "Average Goals + Assists per Game",
    y = "Density",
    fill = "Season",
    color = "Season"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    strip.text = element_text(face = "bold", size = 11)
  )
```

# Goals in match follow Poisson distribution

```{r}

library(pacman)
p_load(dplyr)
p_load(ggplot2)
p_load(fitdistrplus)

game_events <- read.csv("./player-scores/game_events.csv")
games <- read.csv("./player-scores/games.csv")

goals <- game_events %>% 
  filter(type == "Goals") %>%
  dplyr::select(game_id, player_id, date)

goals_per_team <- goals %>%
  group_by(game_id) %>%
  summarise(goals_count = n(), .groups = "drop")

all_games <- games %>%
  dplyr::select(game_id) %>%
  left_join(goals_per_team, by = "game_id") %>%
  mutate(goals_count = ifelse(is.na(goals_count), 0, goals_count))

observed_freq <- all_games %>%
  group_by(goals_count) %>%
  summarise(observed = n(), .groups = "drop") %>%
  mutate(observed_proportion = observed / sum(observed))

lambda <- mean(all_games$goals_count)
cat("Mean value of goals per game:", lambda, "\n")

max_goals <- max(observed_freq$goals_count)
expected_freq <- data.frame(
  goals_count = 0:max_goals,
  expected_proportion = dpois(0:max_goals, lambda)
)

comparison <- observed_freq %>%
  full_join(expected_freq, by = "goals_count") %>%
  arrange(goals_count) %>%
  mutate(
    expected = expected_proportion * sum(observed_freq$observed),
    observed = ifelse(is.na(observed), 0, observed)
)

print(comparison)

# Chi-square goodness of fit test
comparison_chi <- comparison %>% mutate(group = case_when(goals_count <= 5 ~ as.character(goals_count), TRUE ~ "6+")) %>%
  group_by(group) %>% summarise(observed = sum(observed), expected = sum(expected), .groups = "drop") %>%
  filter(expected >= 5)

chi_test <- chisq.test(x = comparison_chi$observed, p = comparison_chi$expected / sum(comparison_chi$expected))

cat("\nChi-square test results:\n")
cat("Chi-square statistic:", chi_test$statistic, "\n")
cat("Degrees of freedom:", chi_test$parameter, "\n")
cat("P-value:", chi_test$p.value, "\n")

if (chi_test$p.value > 0.05) {
  cat("We do not reject the null hypothesis (p > 0.05).\n")
  cat("The data follows a Poisson distribution.\n")
} else {
  cat("We reject the null hypothesis (p < 0.05).\n")
  cat("The given data does not follow a Poisson distribution.\n")
}

# Kolmogorov-Smirnov test
ks_test <- ks.test(all_games$goals_count, "ppois", lambda)
cat("\nKolmogorov-Smirnov test results:\n")
cat("D statistic:", ks_test$statistic, "\n")
cat("P-value:", ks_test$p.value, "\n")

# Observed vs Expected frequencies
comparison_long <- comparison %>%
  dplyr::select(goals_count, observed, expected) %>%
  tidyr::pivot_longer(cols = c(observed, expected), names_to = "type", values_to = "frequency")

ggplot(comparison_long, aes(x = goals_count, y = frequency, fill = type)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.7) +
  labs(
    title = "Observed vs Expected Frequencies (Poisson Distribution)",
    subtitle = paste("Lambda =", round(lambda, 3)),
    x = "Number of Goals per Game",
    y = "Frequency",
    fill = "Type"
  ) + theme_minimal() + theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"), plot.subtitle = element_text(hjust = 0.5, size = 10)) +
  scale_fill_manual(values = c("observed" = "#3498DB", "expected" = "#E74C3C"))

ggplot(all_games, aes(sample = goals_count)) +
  stat_qq(distribution = qpois, dparams = list(lambda = lambda)) +
  stat_qq_line(distribution = qpois, dparams = list(lambda = lambda), 
               color = "red", size = 1) +
  labs(title = "Quantile-Quantile Plot: Goals vs Poisson Distribution", x = "Theoretical Poisson Quantiles", y = "Sample Quantiles") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))


cat("Statistical analysis\n")

cat("Hypothesis test results:\n")
cat("Chi-square Test:\n")
cat("Statistic: ", chi_test$statistic, "\n")
cat("Degrees of Freedom: ", chi_test$parameter, "\n")
cat("P-value: ", format(chi_test$p.value, scientific = TRUE), "\n\n")

cat("Kolmogorov-Smirnov Test:\n")
cat("D Statistic: ", round(ks_test$statistic, 4), "\n")
cat("P-value: ", format(ks_test$p.value, scientific = TRUE), "\n\n")


cat("Conclusion\n")

cat("The data does not follow a Poisson distribution.\n")
cat("Both statistical tests reject the null hypothesis (p-values < 0.05).\n\n")

cat("Though the bar chart shows rough alignment between observed and expected.\n")
cat("Unfortunately even small deviations on big sample sizes are significant.\n")

cat("Mean goals per game: ", round(lambda, 3), "\n")
cat("Variance: ", round(var(all_games$goals_count), 3), "\n")
cat("Variance/Mean: ", round(var(all_games$goals_count) / lambda, 3), "\n")
cat("In case of Poisson distribution, variance should equal to the mean.\n")

cat("While the Poisson distribution helps demonstrate general shape of goal scoring\n")
cat("the deviations indicate that real-world football goal\n")
cat("distributions vary severely more than the Poisson model predicts.\n\n")

cat("The extremely small p-values (< 2.2e-16) is a very strong evidence to reject\n")
cat("the hypothesis about Poisson distribution, despite the visually acceptable fit.\n\n")

```

