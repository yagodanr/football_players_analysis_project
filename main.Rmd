```{r}
library(pacman)
p_load(dplyr)
p_load(lubridate)
p_load(ggplot2)
p_load(tidyverse)
```

# Dataset processing

## goals dataset

```{r}
game_events <- read.csv("./player-scores/game_events.csv")
players     <- read.csv("./player-scores/players.csv")
clubs       <- read.csv("./player-scores/clubs.csv")
games       <- read.csv("./player-scores/games.csv")
```

```{r}
game_events <- select(game_events, !c(game_event_id, player_in_id, player_assist_id))
games       <- select(games, game_id, spectators=attendance,
						home_club_name, away_club_name,
						home_club_goals, away_club_goals)
players     <- select(players, player_id, player=name)
clubs       <- select(clubs, club_id, player_club=name)
```

```{r}

game_events <- merge(game_events, players, by = "player_id", all = TRUE)
game_events <- merge(game_events, clubs, by = "club_id", all = TRUE)
game_events <- merge(game_events, games, by = "game_id", all = TRUE)

```

```{r}
# summary(game_events)
game_events <- game_events %>% filter(!is.na(player))
game_events <- arrange(game_events, date, minute)
head(game_events, 100)
```

```{r}
goals   <- game_events[game_events$type=="Goals", ]
goals
```

## appearances dataset

```{r}
appearances <- read.csv("./player-scores/appearances.csv")
appearances <- merge(appearances, clubs, by.x = "player_club_id", by.y = "club_id")
appearances <- select(appearances, player_club_id, game_id, player_id, date,
				player=player_name, player_club, minutes_played,
				yellow_cards, red_cards, goals, assists)
```

```{r}
head(appearances)
```

# Analysis

```{r}
players_of_interest <- c("Cristiano Ronaldo", "Lionel Messi", "Luka Modric", "Thomas Müller", "Neymar", "Kylian Mbappé")
appearances_of_interest <- filter(appearances, player %in% players_of_interest)
```

```{r}
appearances_of_interest <- appearances_of_interest %>%
  mutate(
    month 	= month(date),
	year 	= year(date),
    season 	= case_when(
      month %in% c(12, 1, 2) ~ "Winter",
      month %in% c(3, 4, 5) ~ "Spring",
      month %in% c(6, 7, 8) ~ "Summer",
      month %in% c(9, 10, 11) ~ "Autumn",
      TRUE ~ NA_character_
    )
  )

player_season_stats <- appearances_of_interest %>%
  group_by(player, year, season) %>%
  summarise(
    games = n(),
    goals = sum(goals, na.rm = TRUE),
    assists = sum(assists, na.rm = TRUE),
    minutes = sum(minutes_played, na.rm = TRUE),
	avg_goals = (goals+assists)/games,
    .groups = "drop"
  ) %>%
  arrange(player, year, season)

player_yearly_stats <- appearances_of_interest %>%
  group_by(player, year) %>%
  summarise(
    games = n(),
    goals = sum(goals, na.rm = TRUE),
    assists = sum(assists, na.rm = TRUE),
    minutes = sum(minutes_played, na.rm = TRUE),
    avg_goals = (goals+assists) / games,
    .groups = "drop"
  )
```

```{r}
# Create the line plot
ggplot(player_yearly_stats, aes(x = year, y = avg_goals, color = player)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Average Goals + Assists per Game by Year",
    x = "Year",
    y = "Average Goals + Assists per Game",
    color = "Player"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")
  ) +
  scale_color_manual(values = c(
    "Cristiano Ronaldo" = "#E74C3C",
    "Lionel Messi" = "#3498DB",
    "Luka Modric" = "#F39C12",
    "Thomas Müller" = "#9B59B6",
    "Neymar" = "#2ECC71",
    "Kylian Mbappé" = "#E67E22"
  ))

# Create line plot with facets for each season
ggplot(player_season_stats, aes(x = year, y = avg_goals, color = player)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ season, ncol = 2) +
  labs(
    title = "Average Goals + Assists per Game by Season Across Years",
    x = "Year",
    y = "Average Goals + Assists per Game",
    color = "Player"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, line = 14, face = "bold"),
    strip.text = element_text(face = "bold", size = 12)
  ) +
  scale_color_manual(values = c(
    "Cristiano Ronaldo" = "#E74C3C",
    "Lionel Messi" = "#3498DB",
    "Luka Modric" = "#F39C12",
    "Thomas Müller" = "#9B59B6",
    "Neymar" = "#2ECC71",
    "Kylian Mbappé" = "#E67E22"
  ))
```

```{r}
# Density plots faceted by player, colored by season
ggplot(player_season_stats, aes(x = avg_goals, fill = season, color = season)) +
  geom_density(alpha = 0.5, size = 1) +
  facet_wrap(~ player, ncol = 2, scales = "free") +
  labs(
    title = "Distribution of Average Goals + Assists per Game by Player",
    x = "Average Goals + Assists per Game",
    y = "Density",
    fill = "Season",
    color = "Season"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    strip.text = element_text(face = "bold", size = 11)
  )
```

# Hypotesys 3

```{r}
players <- read_csv("./player-scores/players.csv")
appearances <- read_csv("./player-scores/appearances.csv")
games <- read_csv("./player-scores/games.csv")

df <- appearances %>%
  select(-any_of("date")) %>%
  left_join(games %>% select(game_id, match_date = date), by = "game_id") %>%
  left_join(players %>% select(player_id, date_of_birth, position), by = "player_id") %>%
  filter(!is.na(match_date), !is.na(date_of_birth)) %>%
  mutate(
    match_date = as.Date(match_date),
    dob = as.Date(date_of_birth),
    age_at_match = as.numeric(difftime(match_date, dob, units = "days")) / 365.25
  )

attackers_df <- df %>%
  filter(position == "Attack") %>%
  filter(minutes_played > 45) %>% 
  mutate(performance = goals + assists)

head(attackers_df)
```

```{r}
target_names <- "Lionel Messi|Cristiano Ronaldo|Zlatan Ibrahimović"

superstars_df <- attackers_df %>%
  filter(grepl(target_names, player_name, ignore.case = TRUE)) %>%
  mutate(player_label = case_when(
    grepl("Lionel Messi", player_name) ~ "Lionel Messi",
    grepl("Cristiano Ronaldo", player_name) ~ "Cristiano Ronaldo",
    grepl("Zlatan Ibrahimović", player_name) ~ "Zlatan Ibrahimović",
    TRUE ~ player_name
  ))

superstars_anova <- superstars_df %>%
  mutate(career_stage = case_when(
    age_at_match < 30 ~ "1. Developing (<30)",
    age_at_match >= 30 & age_at_match < 35 ~ "2. Prime (30-34)",
    age_at_match >= 35 ~ "3. Veteran (34+)"
  ))

ggplot(superstars_anova, aes(x = career_stage, y = performance, fill = player_label)) +
  geom_boxplot(alpha = 0.5) +
  labs(
    title = "Performance by Age Group: The Superstars",
    subtitle = "Comparing Young vs. Prime vs. Veteran (30+)",
    x = "Career Stage",
    y = "Goals + Assists per Match"
  ) +
  theme_minimal()

model_superstar <- aov(performance ~ career_stage, data = superstars_anova)

cat("--- ANOVA Results for Superstars ---\n")
summary(model_superstar)

cat("\n--- Detailed Comparison ---\n")
TukeyHSD(model_superstar)
```
